# RUN: rm -rf %t.default && mkdir -p %t.default && (cd %t.default && %dsdlc --target-language c %S/fixtures >/dev/null 2>&1) && test -f %t.default/nunavut_out/fixtures/vendor/Type_1_0.h
# RUN: rm -rf %t.custom && %dsdlc --target-language c --outdir %t.custom %S/fixtures >/dev/null 2>&1 && test -f %t.custom/fixtures/vendor/Type_1_0.h
# RUN: rm -rf %t.no-overwrite && %dsdlc --target-language c --outdir %t.no-overwrite %S/fixtures >/dev/null 2>&1
# RUN: not %dsdlc --target-language c --no-overwrite --outdir %t.no-overwrite %S/fixtures 2>&1 | FileCheck %s --check-prefix=NO_OVERWRITE
# RUN: rm -rf %t.mode && %dsdlc --target-language c --file-mode 0o640 --outdir %t.mode %S/fixtures >/dev/null 2>&1
# RUN: python3 -c "import os; m = os.stat(r'%t.mode/fixtures/vendor/Type_1_0.h').st_mode & 0o777; assert m == 0o640, oct(m)"
# RUN: not %dsdlc --target-language c --file-mode 0o --outdir %t.mode-bad %S/fixtures 2>&1 | FileCheck %s --check-prefix=BAD_FILE_MODE
# RUN: rm -rf %t.md && %dsdlc --target-language c -MD --outdir %t.md %S/fixtures >/dev/null 2>&1 && test -f %t.md/fixtures/vendor/Type_1_0.h.d
# RUN: cat %t.md/fixtures/vendor/Type_1_0.h.d | FileCheck %s --check-prefix=MD_DEPFILE
# RUN: rm -rf %t.md-mode && %dsdlc --target-language c -MD --file-mode 0o640 --outdir %t.md-mode %S/fixtures >/dev/null 2>&1
# RUN: python3 -c "import os; m = os.stat(r'%t.md-mode/fixtures/vendor/Type_1_0.h.d').st_mode & 0o777; assert m == 0o640, oct(m)"
# RUN: not %dsdlc --target-language ast %S/fixtures_unregulated 2>&1 | FileCheck %s --check-prefix=UNREG
# RUN: %dsdlc --target-language ast --allow-unregulated-fixed-port-id %S/fixtures_unregulated 2>&1 | FileCheck %s --check-prefix=ALLOW_UNREG
# RUN: %dsdlc --target-language c --list-outputs --omit-dependencies --outdir %t.omit --lookup-dir %S/fixtures %S/fixtures/vendor/UsesDelimited.1.0.dsdl 2>/dev/null | FileCheck %s --check-prefix=OMIT_DEPS
# RUN: %dsdlc --target-language c -MD --list-outputs --outdir %t.md-list %S/fixtures 2>/dev/null | FileCheck %s --check-prefix=MD_LIST_OUTPUTS
# RUN: %dsdlc --target-language ast -vv %S/fixtures 2>&1 >/dev/null | FileCheck %s --check-prefix=VERBOSE
# RUN: rm -rf %t.dry && %dsdlc --target-language c --dry-run --outdir %t.dry %S/fixtures >/dev/null 2>&1 && test ! -e %t.dry
# RUN: rm -rf %t.md-dry && %dsdlc --target-language c -MD --dry-run --outdir %t.md-dry %S/fixtures >/dev/null 2>&1 && test ! -e %t.md-dry
# RUN: rm -rf %t.list-implies-dry-run && %dsdlc --target-language c --list-outputs --outdir %t.list-implies-dry-run %S/fixtures >/dev/null 2>/dev/null && test ! -e %t.list-implies-dry-run
# RUN: %dsdlc --target-language c --list-inputs --list-outputs --outdir %t.list-both %S/fixtures 2>/dev/null | FileCheck %s --check-prefix=LIST_BOTH
# RUN: %dsdlc --target-language c -MD --list-inputs --list-outputs --outdir %t.md-list-both %S/fixtures 2>/dev/null | FileCheck %s --check-prefix=MD_LIST_BOTH
# RUN: rm -rf %t.md-no-overwrite && %dsdlc --target-language c -MD --outdir %t.md-no-overwrite %S/fixtures >/dev/null 2>&1
# RUN: find %t.md-no-overwrite -type f ! -name '*.d' -delete
# RUN: not %dsdlc --target-language c -MD --no-overwrite --outdir %t.md-no-overwrite %S/fixtures 2>&1 | FileCheck %s --check-prefix=MD_NO_OVERWRITE
# RUN: rm -rf %t.md-omit && %dsdlc --target-language c -MD --omit-dependencies --outdir %t.md-omit --lookup-dir %S/fixtures %S/fixtures/vendor/UsesDelimited.1.0.dsdl >/dev/null 2>&1
# RUN: test -f %t.md-omit/fixtures/vendor/UsesDelimited_1_0.h.d
# RUN: test ! -e %t.md-omit/fixtures/vendor/Delimited_1_0.h
# RUN: cat %t.md-omit/fixtures/vendor/UsesDelimited_1_0.h.d | FileCheck %s --check-prefix=MD_OMIT_DEPS
# RUN: %dsdlc --target-language ast --list-inputs --lookup-dir %S/fixtures %S/fixtures/vendor/Type.1.0.dsdl 2>/dev/null | FileCheck %s --check-prefix=LOOKUP_INFER
# RUN: %dsdlc --target-language ast --list-inputs %S/fixtures:vendor/Type.1.0.dsdl 2>/dev/null | FileCheck %s --check-prefix=COLON_TARGET
# RUN: env DSDL_INCLUDE_PATH=%S/fixtures %dsdlc --target-language ast --list-inputs %S/fixtures/vendor/Type.1.0.dsdl 2>/dev/null | FileCheck %s --check-prefix=ENV_INCLUDE
# RUN: rm -rf %t.cyphal && mkdir -p %t.cyphal/fixtures/vendor && cp %S/fixtures/vendor/Type.1.0.dsdl %t.cyphal/fixtures/vendor/Type.1.0.dsdl
# RUN: env CYPHAL_PATH=%t.cyphal %dsdlc --target-language ast --list-inputs %t.cyphal/fixtures/vendor/Type.1.0.dsdl 2>/dev/null | FileCheck %s --check-prefix=ENV_CYPHAL
# RUN: not %dsdlc --target-language ast --list-inputs %S/fixtures/vendor/Type.1.0.dsdl 2>&1 | FileCheck %s --check-prefix=INFER_FAIL
# RUN: not %dsdlc --target-language ast --list-inputs --lookup-dir %S --lookup-dir %S/fixtures %S/fixtures/vendor/Type.1.0.dsdl 2>&1 | FileCheck %s --check-prefix=INFER_AMBIGUOUS

# NO_OVERWRITE: refusing to overwrite existing output file:

# BAD_FILE_MODE: invalid --file-mode value: 0o

# MD_DEPFILE: Type_1_0.h:
# MD_DEPFILE: Type.1.0.dsdl

# UNREG: regulated port-ID 1234 for message type fixtures_unregulated.Unregulated is not valid; use --allow-unregulated-fixed-port-id to override

# ALLOW_UNREG: Run summary:
# ALLOW_UNREG: command: ast

# OMIT_DEPS: {{.*/}}dsdl_runtime.h;{{.*/}}UsesDelimited_1_0.c;{{.*/}}UsesDelimited_1_0.h
# OMIT_DEPS-NOT: /Delimited_1_0.

# MD_LIST_OUTPUTS: {{.*Type_1_0\.h;.*Type_1_0\.h\.d.*}}

# VERBOSE: [dsdlc] resolving target paths
# VERBOSE: [dsdlc] discovering and parsing definitions
# VERBOSE: [dsdlc] running semantic analysis

# LIST_BOTH: {{.*\.dsdl;;.*dsdl_runtime\.h.*}}

# MD_LIST_BOTH: {{.*\.dsdl;;.*\.d.*}}

# MD_NO_OVERWRITE: refusing to overwrite existing output file:
# MD_NO_OVERWRITE: .d

# MD_OMIT_DEPS: {{.*UsesDelimited_1_0\.h: .*Delimited\.1\.0\.dsdl.*UsesDelimited\.1\.0\.dsdl.*}}

# LOOKUP_INFER: {{.*/}}Type.1.0.dsdl

# COLON_TARGET: {{.*/}}Type.1.0.dsdl

# ENV_INCLUDE: {{.*/}}Type.1.0.dsdl

# ENV_CYPHAL: {{.*/}}Type.1.0.dsdl

# INFER_FAIL: cannot infer root namespace for target file; specify --lookup-dir or use colon syntax

# INFER_AMBIGUOUS: ambiguous root namespace for target file
