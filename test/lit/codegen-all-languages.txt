# RUN: rm -rf %t && mkdir -p %t
# RUN: %dsdlc --version | FileCheck %s --check-prefix=CLI_VERSION
# RUN: %dsdlc --target-language cpp %S/fixtures --cpp-profile both --outdir %t/cpp 2>&1 | FileCheck %s --check-prefix=CPP_SUMMARY
# RUN: test -f %t/cpp/std/fixtures/vendor/Type_1_0.hpp
# RUN: test -f %t/cpp/pmr/fixtures/vendor/Type_1_0.hpp
# RUN: cat %t/cpp/std/fixtures/vendor/Type_1_0.hpp | FileCheck %s --check-prefix=CPP_STD
# RUN: cat %t/cpp/pmr/fixtures/vendor/Type_1_0.hpp | FileCheck %s --check-prefix=CPP_PMR

# RUN: %dsdlc --target-language rust %S/fixtures --rust-profile std --rust-crate-name llvmdsdl_smoke_std --outdir %t/rust-std 2>&1 | FileCheck %s --check-prefix=RUST_STD_SUMMARY
# RUN: test -f %t/rust-std/src/fixtures/vendor/helpers_1_0.rs
# RUN: cat %t/rust-std/Cargo.toml | FileCheck %s --check-prefix=RUST_STD
# RUN: cat %t/rust-std/src/fixtures/vendor/helpers_1_0.rs | FileCheck %s --check-prefix=RUST_STD_TYPE

# RUN: %dsdlc --target-language rust %S/fixtures --rust-profile no-std-alloc --rust-runtime-specialization fast --rust-crate-name llvmdsdl_smoke_fast --outdir %t/rust-fast 2>&1 | FileCheck %s --check-prefix=RUST_FAST_SUMMARY
# RUN: test -f %t/rust-fast/src/fixtures/vendor/helpers_1_0.rs
# RUN: cat %t/rust-fast/Cargo.toml | FileCheck %s --check-prefix=RUST_FAST

# RUN: %dsdlc --target-language go %S/fixtures --go-module demo/generated/smoke --outdir %t/go 2>&1 | FileCheck %s --check-prefix=GO_SUMMARY
# RUN: test -f %t/go/go.mod
# RUN: test -f %t/go/dsdlruntime/dsdl_runtime.go
# RUN: test -f %t/go/fixtures/vendor/helpers_1_0.go
# RUN: cat %t/go/go.mod | FileCheck %s --check-prefix=GO_MODULE

# RUN: %dsdlc --target-language ts %S/fixtures --ts-module demo_ts_smoke_portable --ts-runtime-specialization portable --outdir %t/ts-portable 2>&1 | FileCheck %s --check-prefix=TS_PORTABLE_SUMMARY
# RUN: test -f %t/ts-portable/dsdl_runtime.ts
# RUN: test -f %t/ts-portable/fixtures/vendor/helpers_1_0.ts
# RUN: cat %t/ts-portable/package.json | FileCheck %s --check-prefix=TS_PORTABLE_PACKAGE
# RUN: cat %t/ts-portable/dsdl_runtime.ts | FileCheck %s --check-prefix=TS_PORTABLE_RUNTIME
# RUN: cat %t/ts-portable/fixtures/vendor/helpers_1_0.ts | FileCheck %s --check-prefix=TS_HELPERS

# RUN: %dsdlc --target-language ts %S/fixtures --ts-module demo_ts_smoke_fast --ts-runtime-specialization fast --outdir %t/ts-fast 2>&1 | FileCheck %s --check-prefix=TS_FAST_SUMMARY
# RUN: test -f %t/ts-fast/dsdl_runtime.ts
# RUN: test -f %t/ts-fast/fixtures/vendor/helpers_1_0.ts
# RUN: cat %t/ts-fast/package.json | FileCheck %s --check-prefix=TS_FAST_PACKAGE
# RUN: cat %t/ts-fast/dsdl_runtime.ts | FileCheck %s --check-prefix=TS_FAST_RUNTIME

# RUN: %dsdlc --target-language python %S/fixtures --py-package demo_py_smoke --py-runtime-specialization portable --outdir %t/python-portable 2>&1 | FileCheck %s --check-prefix=PY_PORTABLE_SUMMARY
# RUN: test -f %t/python-portable/pyproject.toml
# RUN: test -f %t/python-portable/demo_py_smoke/_dsdl_runtime.py
# RUN: test -f %t/python-portable/demo_py_smoke/_runtime_loader.py
# RUN: test -f %t/python-portable/demo_py_smoke/py.typed
# RUN: test -f %t/python-portable/demo_py_smoke/llvmdsdl_codegen.json
# RUN: test -f %t/python-portable/demo_py_smoke/fixtures/vendor/helpers_1_0.py
# RUN: cat %t/python-portable/pyproject.toml | FileCheck %s --check-prefix=PY_PYPROJECT
# RUN: cat %t/python-portable/demo_py_smoke/llvmdsdl_codegen.json | FileCheck %s --check-prefix=PY_PORTABLE_PACKAGE
# RUN: cat %t/python-portable/demo_py_smoke/_dsdl_runtime.py | FileCheck %s --check-prefix=PY_PORTABLE_RUNTIME
# RUN: cat %t/python-portable/demo_py_smoke/fixtures/vendor/helpers_1_0.py | FileCheck %s --check-prefix=PY_HELPERS

# RUN: %dsdlc --target-language python %S/fixtures --py-package demo_py_smoke --py-runtime-specialization fast --outdir %t/python-fast 2>&1 | FileCheck %s --check-prefix=PY_FAST_SUMMARY
# RUN: test -f %t/python-fast/pyproject.toml
# RUN: test -f %t/python-fast/demo_py_smoke/_dsdl_runtime.py
# RUN: test -f %t/python-fast/demo_py_smoke/_runtime_loader.py
# RUN: test -f %t/python-fast/demo_py_smoke/py.typed
# RUN: test -f %t/python-fast/demo_py_smoke/llvmdsdl_codegen.json
# RUN: test -f %t/python-fast/demo_py_smoke/fixtures/vendor/helpers_1_0.py
# RUN: cat %t/python-fast/demo_py_smoke/llvmdsdl_codegen.json | FileCheck %s --check-prefix=PY_FAST_PACKAGE
# RUN: cat %t/python-fast/demo_py_smoke/_dsdl_runtime.py | FileCheck %s --check-prefix=PY_FAST_RUNTIME
# RUN: cmp -s %t/python-portable/demo_py_smoke/fixtures/vendor/helpers_1_0.py %t/python-fast/demo_py_smoke/fixtures/vendor/helpers_1_0.py

# CPP_SUMMARY: Run summary:
# CPP_SUMMARY: command: cpp
# CPP_SUMMARY: output root:
# CPP_SUMMARY: files generated:

# CPP_STD: #include <vector>
# CPP_PMR: #include <memory_resource>

# RUST_STD_SUMMARY: Run summary:
# RUST_STD_SUMMARY: command: rust
# RUST_STD_SUMMARY: files generated:
# RUST_STD: name = "llvmdsdl_smoke_std"
# RUST_STD: version = "{{[0-9]+\.[0-9]+\.[0-9]+}}"
# RUST_STD: [package.metadata.llvmdsdl]
# RUST_STD: generator-version = "{{[0-9]+\.[0-9]+\.[0-9]+}}"
# RUST_STD: rust-profile = "std"
# RUST_STD: rust-runtime-specialization = "portable"
# RUST_STD: rust-memory-mode = "max-inline"
# RUST_STD: rust-inline-threshold-bytes = 256
# RUST_STD: default = ["std"]
# RUST_STD_TYPE: __LLVMDSDL_MEMORY_MODE: crate::dsdl_runtime::DsdlMemoryMode = crate::dsdl_runtime::DsdlMemoryMode::MaxInline;
# RUST_STD_TYPE: __LLVMDSDL_INLINE_THRESHOLD_BYTES: usize = 256usize;
# RUST_STD_TYPE: __LLVMDSDL_POOL_CLASS_C: crate::dsdl_runtime::AllocationClassId = crate::dsdl_runtime::AllocationClassId(1u32);
# RUST_STD_TYPE: self.c.set_memory_contract(crate::dsdl_runtime::VarArrayMemoryContract::new(Self::__LLVMDSDL_MEMORY_MODE, Self::__LLVMDSDL_INLINE_THRESHOLD_BYTES, Self::__LLVMDSDL_POOL_CLASS_C));
# RUST_STD_TYPE: crate::dsdl_runtime::PassthroughPoolProvider::default()
# RUST_STD_TYPE: self.c.reserve_with_pool(_count

# RUST_FAST_SUMMARY: Run summary:
# RUST_FAST_SUMMARY: command: rust
# RUST_FAST_SUMMARY: files generated:
# RUST_FAST: name = "llvmdsdl_smoke_fast"
# RUST_FAST: rust-profile = "no-std-alloc"
# RUST_FAST: rust-runtime-specialization = "fast"
# RUST_FAST: rust-memory-mode = "max-inline"
# RUST_FAST: default = ["runtime-fast"]

# GO_SUMMARY: Run summary:
# GO_SUMMARY: command: go
# GO_SUMMARY: files generated:
# GO_MODULE: module demo/generated/smoke

# TS_PORTABLE_SUMMARY: Run summary:
# TS_PORTABLE_SUMMARY: command: ts
# TS_PORTABLE_SUMMARY: files generated:
# TS_PORTABLE_PACKAGE: "generatorVersion": "{{[0-9]+\.[0-9]+\.[0-9]+}}"
# TS_PORTABLE_PACKAGE: "tsRuntimeSpecialization": "portable"
# TS_PORTABLE_RUNTIME: export function copyBits(
# TS_PORTABLE_RUNTIME-NOT: dst.set(src.subarray
# TS_HELPERS: const mlir_
# TS_HELPERS: mlir_

# TS_FAST_SUMMARY: Run summary:
# TS_FAST_SUMMARY: command: ts
# TS_FAST_SUMMARY: files generated:
# TS_FAST_PACKAGE: "tsRuntimeSpecialization": "fast"
# TS_FAST_RUNTIME: dst.set(src.subarray
# TS_FAST_RUNTIME: return src.slice(

# PY_PORTABLE_SUMMARY: Run summary:
# PY_PORTABLE_SUMMARY: command: python
# PY_PORTABLE_SUMMARY: files generated:
# PY_PORTABLE_PACKAGE: "generatorVersion": "{{[0-9]+\.[0-9]+\.[0-9]+}}"
# PY_PORTABLE_PACKAGE: "pythonRuntimeSpecialization": "portable"
# PY_PORTABLE_RUNTIME-NOT: dst_start = dst_off_bits // 8

# PY_FAST_SUMMARY: Run summary:
# PY_FAST_SUMMARY: command: python
# PY_FAST_SUMMARY: files generated:
# PY_FAST_PACKAGE: "pythonRuntimeSpecialization": "fast"

# CLI_VERSION: dsdlc [[MAJOR:[0-9]+]].[[MINOR:[0-9]+]].[[PATCH:[0-9]+]]
# PY_FAST_RUNTIME: dst_start = dst_off_bits // 8
# PY_PYPROJECT: [build-system]
# PY_PYPROJECT: build-backend = "setuptools.build_meta"
# PY_PYPROJECT: [project]
# PY_PYPROJECT: requires-python = ">=3.10"
# PY_PYPROJECT: [tool.setuptools.package-data]
# PY_PYPROJECT: _dsdl_runtime_accel*.so
# PY_HELPERS: @dataclass(slots=True)
# PY_HELPERS: def serialize(self) -> bytes:
# PY_HELPERS: def deserialize(cls, data: bytes | bytearray | memoryview)
# PY_HELPERS: def mlir_
# PY_HELPERS: mlir_
