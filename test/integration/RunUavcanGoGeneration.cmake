cmake_minimum_required(VERSION 3.24)

foreach(var DSDLC UAVCAN_ROOT OUT_DIR)
  if(NOT DEFINED ${var} OR "${${var}}" STREQUAL "")
    message(FATAL_ERROR "Missing required variable: ${var}")
  endif()
endforeach()

if(NOT EXISTS "${DSDLC}")
  message(FATAL_ERROR "dsdlc executable not found: ${DSDLC}")
endif()

if(NOT EXISTS "${UAVCAN_ROOT}")
  message(FATAL_ERROR "uavcan root not found: ${UAVCAN_ROOT}")
endif()

file(REMOVE_RECURSE "${OUT_DIR}")
file(MAKE_DIRECTORY "${OUT_DIR}")

execute_process(
  COMMAND
    "${DSDLC}" go
      --root-namespace-dir "${UAVCAN_ROOT}"
      --strict
      --out-dir "${OUT_DIR}"
      --go-module "uavcan_dsdl_generated"
  RESULT_VARIABLE gen_result
  OUTPUT_VARIABLE gen_stdout
  ERROR_VARIABLE gen_stderr
)
if(NOT gen_result EQUAL 0)
  message(STATUS "dsdlc stdout:\n${gen_stdout}")
  message(STATUS "dsdlc stderr:\n${gen_stderr}")
  message(FATAL_ERROR "uavcan Go generation failed")
endif()

foreach(required
    "${OUT_DIR}/go.mod"
    "${OUT_DIR}/dsdlruntime/dsdl_runtime.go")
  if(NOT EXISTS "${required}")
    message(FATAL_ERROR "Missing required generated file: ${required}")
  endif()
endforeach()

file(GLOB_RECURSE dsdl_files "${UAVCAN_ROOT}/*.dsdl")
list(LENGTH dsdl_files dsdl_count)

file(GLOB_RECURSE go_files "${OUT_DIR}/*.go")
set(type_go_files "")
foreach(gf IN LISTS go_files)
  get_filename_component(name "${gf}" NAME)
  if(NOT name STREQUAL "dsdl_runtime.go")
    list(APPEND type_go_files "${gf}")
  endif()
endforeach()
list(LENGTH type_go_files type_go_count)

set(found_mlir_union_helper FALSE)
set(found_mlir_union_validate_helper FALSE)
set(found_mlir_union_validate_call FALSE)
set(found_mlir_capacity_check_helper FALSE)
set(found_mlir_capacity_check_call FALSE)
set(found_mlir_array_prefix_helper FALSE)
set(found_mlir_array_prefix_call FALSE)
set(found_mlir_array_validate_helper FALSE)
set(found_mlir_array_validate_call FALSE)
set(found_mlir_scalar_unsigned_helper FALSE)
set(found_mlir_scalar_unsigned_call FALSE)
set(found_mlir_scalar_signed_helper FALSE)
set(found_mlir_scalar_signed_call FALSE)
set(found_mlir_scalar_float_helper FALSE)
set(found_mlir_scalar_float_call FALSE)
set(found_mlir_delimiter_validate_helper FALSE)
set(found_mlir_delimiter_validate_call FALSE)
set(found_runtime_write_call FALSE)
set(found_runtime_read_call FALSE)
set(found_backend_fallback_signature FALSE)
set(found_backend_array_length_fallback_signature FALSE)
set(found_backend_delimiter_fallback_signature FALSE)
set(found_backend_scalar_deser_fallback_signature FALSE)
foreach(gf IN LISTS type_go_files)
  file(READ "${gf}" go_text)
  if(go_text MATCHES "__llvmdsdl_plan_union_tag__")
    set(found_mlir_union_helper TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_validate_union_tag__")
    set(found_mlir_union_validate_helper TRUE)
  endif()
  if(go_text MATCHES "if rc := mlir___llvmdsdl_plan_validate_union_tag__")
    set(found_mlir_union_validate_call TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_capacity_check__")
    set(found_mlir_capacity_check_helper TRUE)
  endif()
  if(go_text MATCHES "if rc := mlir___llvmdsdl_plan_capacity_check__")
    set(found_mlir_capacity_check_call TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_array_length_prefix__")
    set(found_mlir_array_prefix_helper TRUE)
  endif()
  if(go_text MATCHES "dsdlruntime\\.SetUxx\\([^\\n]*mlir___llvmdsdl_plan_array_length_prefix__")
    set(found_mlir_array_prefix_call TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_validate_array_length__")
    set(found_mlir_array_validate_helper TRUE)
  endif()
  if(go_text MATCHES "_lenRc[0-9_]* := mlir___llvmdsdl_plan_validate_array_length__")
    set(found_mlir_array_validate_call TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_scalar_unsigned__")
    set(found_mlir_scalar_unsigned_helper TRUE)
  endif()
  if(go_text MATCHES "= uint[0-9]+\\(mlir___llvmdsdl_plan_scalar_unsigned__")
    set(found_mlir_scalar_unsigned_call TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_scalar_signed__")
    set(found_mlir_scalar_signed_helper TRUE)
  endif()
  if(go_text MATCHES "= int[0-9]+\\(mlir___llvmdsdl_plan_scalar_signed__")
    set(found_mlir_scalar_signed_call TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_scalar_float__")
    set(found_mlir_scalar_float_helper TRUE)
  endif()
  if(go_text MATCHES "= float(32|64)\\(mlir___llvmdsdl_plan_scalar_float__")
    set(found_mlir_scalar_float_call TRUE)
  endif()
  if(go_text MATCHES "__llvmdsdl_plan_validate_delimiter_header__")
    set(found_mlir_delimiter_validate_helper TRUE)
  endif()
  if(go_text MATCHES "_rc[0-9_]* := mlir___llvmdsdl_plan_validate_delimiter_header__")
    set(found_mlir_delimiter_validate_call TRUE)
  endif()
  if(go_text MATCHES "dsdlruntime\\.SetUxx\\(")
    set(found_runtime_write_call TRUE)
  endif()
  if(go_text MATCHES "dsdlruntime\\.GetU64\\(")
    set(found_runtime_read_call TRUE)
  endif()
  if(go_text MATCHES "_sat[0-9_]* := ")
    set(found_backend_fallback_signature TRUE)
  endif()
  if(go_text MATCHES "if len\\([^\\)]*\\) > [0-9]+")
    set(found_backend_array_length_fallback_signature TRUE)
  endif()
  if(go_text MATCHES "_sizeBytes[0-9_]* > _remaining")
    set(found_backend_delimiter_fallback_signature TRUE)
  endif()
  if(go_text MATCHES "obj\\.[A-Za-z0-9_]+ = dsdlruntime\\.Get(U|I|F)(16|32|64)\\(")
    set(found_backend_scalar_deser_fallback_signature TRUE)
  endif()
endforeach()

if(NOT found_mlir_union_helper)
  message(FATAL_ERROR "Missing MLIR union-tag helper markers in generated Go files")
endif()
if(NOT found_mlir_union_validate_helper)
  message(FATAL_ERROR "Missing MLIR union-tag-validate helper markers in generated Go files")
endif()
if(NOT found_mlir_union_validate_call)
  message(FATAL_ERROR "Missing MLIR union-tag-validate helper call sites in generated Go files")
endif()
if(NOT found_mlir_capacity_check_helper)
  message(FATAL_ERROR "Missing MLIR capacity-check helper markers in generated Go files")
endif()
if(NOT found_mlir_capacity_check_call)
  message(FATAL_ERROR "Missing MLIR capacity-check helper call sites in generated Go files")
endif()
if(NOT found_mlir_array_prefix_helper)
  message(FATAL_ERROR "Missing MLIR array-prefix helper markers in generated Go files")
endif()
if(NOT found_mlir_array_prefix_call)
  message(FATAL_ERROR "Missing MLIR array-prefix helper call sites in generated Go files")
endif()
if(NOT found_mlir_array_validate_helper)
  message(FATAL_ERROR "Missing MLIR array-validate helper markers in generated Go files")
endif()
if(NOT found_mlir_array_validate_call)
  message(FATAL_ERROR "Missing MLIR array-validate helper call sites in generated Go files")
endif()
if(NOT found_mlir_scalar_unsigned_helper)
  message(FATAL_ERROR "Missing MLIR scalar-unsigned helper markers in generated Go files")
endif()
if(NOT found_mlir_scalar_unsigned_call)
  message(FATAL_ERROR "Missing MLIR scalar-unsigned helper call sites in generated Go files")
endif()
if(NOT found_mlir_scalar_signed_helper)
  message(FATAL_ERROR "Missing MLIR scalar-signed helper markers in generated Go files")
endif()
if(NOT found_mlir_scalar_signed_call)
  message(FATAL_ERROR "Missing MLIR scalar-signed helper call sites in generated Go files")
endif()
if(NOT found_mlir_scalar_float_helper)
  message(FATAL_ERROR "Missing MLIR scalar-float helper markers in generated Go files")
endif()
if(NOT found_mlir_scalar_float_call)
  message(FATAL_ERROR "Missing MLIR scalar-float helper call sites in generated Go files")
endif()
if(NOT found_mlir_delimiter_validate_helper)
  message(FATAL_ERROR "Missing MLIR delimiter-validate helper markers in generated Go files")
endif()
if(NOT found_mlir_delimiter_validate_call)
  message(FATAL_ERROR "Missing MLIR delimiter-validate helper call sites in generated Go files")
endif()
if(NOT found_runtime_write_call)
  message(FATAL_ERROR "Generated Go files are missing dsdlruntime.SetUxx calls; serialize path appears stubbed")
endif()
if(NOT found_runtime_read_call)
  message(FATAL_ERROR "Generated Go files are missing dsdlruntime.GetU64 calls; deserialize path appears stubbed")
endif()
if(found_backend_fallback_signature)
  message(FATAL_ERROR "Found backend fallback saturation signatures in generated Go files")
endif()
if(found_backend_array_length_fallback_signature)
  message(FATAL_ERROR "Found backend inline array-length fallback signatures in generated Go files")
endif()
if(found_backend_delimiter_fallback_signature)
  message(FATAL_ERROR "Found backend inline delimiter fallback signatures in generated Go files")
endif()
if(found_backend_scalar_deser_fallback_signature)
  message(FATAL_ERROR "Found backend scalar-deserialize fallback signatures in generated Go files")
endif()

if(NOT dsdl_count EQUAL type_go_count)
  message(FATAL_ERROR
    "Go type file count mismatch: dsdl=${dsdl_count}, generated=${type_go_count}")
endif()

message(STATUS
  "uavcan Go generation check passed: ${dsdl_count} DSDL -> ${type_go_count} Go type files")
